<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ´ÙƒÙŠÙ„Ø§Øª Ø§Ù„Ù‚Ù…Ø§Ø´ Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f7;
      color: #111827;
    }

    header {
      background: #111827;
      color: #fff;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
    }

    nav a {
      margin-right: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      text-decoration: none;
      background: #374151;
      color: #fff;
      white-space: nowrap;
    }

    nav a.active {
      background: #4b7bec;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto 40px;
      padding: 0 16px;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      padding: 20px 18px 24px;
      box-shadow: 0 12px 35px rgba(15,23,42,0.08);
      margin-bottom: 20px;
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 14px;
    }

    h3 {
      margin-top: 0;
      font-size: 16px;
      margin-bottom: 10px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      color: #4b5563;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 10px;
      background: #f9fafb;
    }

    textarea {
      resize: vertical;
      min-height: 40px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .col {
      flex: 1;
      min-width: 220px;
    }

    button.primary {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #4b7bec;
      color: #fff;
      margin-top: 4px;
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-secondary {
      background: #10b981;
    }

    .btn-warning {
      background: #f5a623;
    }

    .btn-danger {
      background: #ef4444;
    }

    .btn-neutral {
      background: #6b7280;
    }

    .msg {
      margin-top: 8px;
      font-size: 13px;
    }

    .msg.error {
      color: #dc2626;
    }

    .msg.ok {
      color: #16a34a;
    }

    .printed-top-info {
      padding: 12px 14px;
      border-radius: 12px;
      background: #f3f4f6;
      margin-bottom: 16px;
    }

    .mariage-group {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 12px;
      margin-bottom: 10px;
      background: #f9fafb;
    }

    .mariage-group h4 {
      margin: 0 0 8px;
      font-size: 14px;
      color: #111827;
    }

    .file-input {
      font-size: 12px;
      margin-bottom: 6px;
    }

    .thumb {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      object-fit: cover;
      display: none;
      margin-top: 4px;
    }

    .mariage-actions-local {
      margin-top: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }

    tr:nth-child(even) {
      background: #fcfcfd;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 86px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
    }

    .status-not {
      background: #f97373;
    }

    .status-printed {
      background: #22c55e;
    }

    .status-received {
      background: #0ea5e9;
    }

    .small-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 11px;
      margin: 1px 2px;
      color: #fff;
    }

    .small-btn.edit {
      background: #3b82f6;
    }

    .small-btn.delete {
      background: #ef4444;
    }

    .small-btn.action1 {
      background: #f59e0b;
    }

    .small-btn.action2 {
      background: #10b981;
    }

    .printed-table-img {
      width: 55px;
      height: 55px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #e5e7eb;
    }

    .totals {
      margin-top: 8px;
      font-size: 13px;
      text-align: left;
      color: #111827;
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      nav {
        width: 100%;
        display: flex;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 6px;
      }
      table {
        font-size: 12px;
      }
      th, td {
        padding: 6px 4px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>ØªØ´ÙƒÙŠÙ„Ø§Øª Ø§Ù„Ù‚Ù…Ø§Ø´ Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹</h1>
  <nav>
    <!-- Ø¹Ø¯Ù‘Ù„ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ùˆ Ø§Ø³Ù… ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¯Ø© Ø¹Ù†Ø¯Ùƒ Ù…Ø®ØªÙ„Ù -->
    <a href="index.html">Ù‚Ù…Ø§Ø´ Ø³Ø§Ø¯Ø©</a>
    <a href="printed.html" class="active">Ù‚Ù…Ø§Ø´ Ù…Ø·Ø¨ÙˆØ¹</a>
  </nav>
</header>

<div class="container">
  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø±ÙŠØ§Ø¬Ø§Øª -->
  <section class="card">
    <h2>Ø¥Ø¯Ø®Ø§Ù„ / Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø±ÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø±Ø³Ù…Ø©</h2>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù…Ø© -->
    <div class="printed-top-info">
      <div class="row">
        <div class="col">
          <label for="designCode">Ø±Ù‚Ù… / ÙƒÙˆØ¯ Ø§Ù„Ø±Ø³Ù…Ø©:</label>
          <input id="designCode" type="text" placeholder="Ù…Ø«Ø§Ù„: P-2025-013 Ø£Ùˆ Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ÙŠ" />
        </div>
        <div class="col">
          <label for="screensCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø¨Ù„ÙˆÙ†Ø§Øª:</label>
          <input id="screensCount" type="number" placeholder="Ù…Ø«Ø§Ù„: 6" />
        </div>
      </div>
    </div>

    <!-- Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ§Ø¬ -->
    <h3>Ù…Ø±ÙŠØ§Ø¬Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ù…Ø©</h3>
    <div id="mariagesContainer"></div>

    <button class="primary" id="addMariageBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ§Ø¬ Ø¬Ø¯ÙŠØ¯</button>
    <br /><br />
    <button class="primary btn-secondary" id="saveAllBtn">Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø±ÙŠØ§Ø¬Ø§Øª</button>
    <div class="msg" id="formMessage"></div>
  </section>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø§Øª -->
  <section class="card">
    <h2>Ø¬Ø¯ÙˆÙ„ ØªØ´ÙƒÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹</h2>

    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>Ø§Ù„ØµÙˆØ±Ø©</th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ù…Ø©</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø¨Ù„ÙˆÙ†Ø§Øª</th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ§Ø¬</th>
        <th>Ù†ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</th>
        <th>Ø§Ù„Ø£Ø±Ø¶ÙŠØ©</th>
        <th>Ø§Ù„Ø®Ø§Ù…Ø©</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØº)</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
        <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</th>
        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
      </thead>
      <tbody id="printedTableBody"></tbody>
    </table>

    <div class="totals" id="totalsInfo"></div>
    <div class="msg" id="tableMessage"></div>
  </section>
</div>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  /************* 1) Ø¥Ø¹Ø¯Ø§Ø¯ Supabase *************/
  const SUPABASE_URL = "https://umrczwoxjhxwvrezocrm.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtcmN6d294amh4d3ZyZXpvY3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5ODA0MTUsImV4cCI6MjA3OTU1NjQxNX0.88PDM2h93rhGhOxVRDa5q3rismemqJJEpmBdwWmfgVQ"; // Ø§Ù„ØµÙ‚ÙŠ Ø§Ù„Ù€ anon key Ù‡Ù†Ø§ ÙÙ‚Ø· Ø¹Ù†Ø¯Ùƒ ÙÙŠ Ø§Ù„Ù…Ù„Ù

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const STORAGE_BUCKET = "images";
  const TABLE_NAME = "printed_mariages";

  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  /************* 2) Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ§Ø¬ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ *************/
  const mariagesContainer = document.getElementById("mariagesContainer");
  const addMariageBtn = document.getElementById("addMariageBtn");
  const saveAllBtn = document.getElementById("saveAllBtn");
  const formMessage = document.getElementById("formMessage");

  let mariageCounter = 0;

  function createMariageGroup() {
    mariageCounter++;
    const idx = mariageCounter;

    const wrapper = document.createElement("div");
    wrapper.className = "mariage-group";
    wrapper.dataset.index = idx;

    wrapper.innerHTML = `
      <h4>Ù…Ø±ÙŠØ§Ø¬ Ø±Ù‚Ù… ${idx}</h4>
      <div class="row">
        <div class="col">
          <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙŠØ§Ø¬ (Ù…Ù„Ù Ø£Ùˆ ÙƒØ§Ù…ÙŠØ±Ø§):</label>
          <input class="file-input" type="file" accept="image/*" capture="environment"
                 id="mariageImage_${idx}" />
          <img id="mariagePreview_${idx}" class="thumb" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ÙŠØ§Ø¬" />
        </div>
        <div class="col">
          <label for="mariageNumber_${idx}">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ§Ø¬:</label>
          <input type="text" id="mariageNumber_${idx}" placeholder="Ù…Ø«Ø§Ù„: 1ØŒ 2ØŒ 3..." />

          <label for="printType_${idx}">Ù†ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</label>
          <select id="printType_${idx}">
            <option value="">Ø§Ø®ØªØ§Ø± Ø§Ù„Ù†ÙˆØ¹...</option>
            <option value="Ø¨Ø¬Ù…Ù†Øª">Ø¨Ø¬Ù…Ù†Øª</option>
            <option value="Ø±Ø§ÙƒØªÙ">Ø±Ø§ÙƒØªÙ</option>
            <option value="Ø¯Ø³Ø¨Ø³Ø±Ø³">Ø¯Ø³Ø¨Ø³Ø±Ø³</option>
            <option value="ØµØ¨Ø§ØºØ© Ù…Ø¹ Ø·Ø¨Ø§Ø¹Ø©">ØµØ¨Ø§ØºØ© Ù…Ø¹ Ø·Ø¨Ø§Ø¹Ø©</option>
            <option value="Ø¨Ø±Ù†Ø§ÙˆØª">Ø¨Ø±Ù†Ø§ÙˆØª</option>
          </select>

          <label for="groundPrep_${idx}">ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£Ø±Ø¶ÙŠØ©:</label>
          <select id="groundPrep_${idx}">
            <option value="">Ø§Ø®ØªØ§Ø±...</option>
            <option value="Ø£ÙˆÙÙˆØ§ÙŠØª">Ø£ÙˆÙÙˆØ§ÙŠØª</option>
            <option value="Ø£Ø¨ÙŠØ¶">Ø£Ø¨ÙŠØ¶</option>
          </select>
        </div>
        <div class="col">
          <label for="quality_${idx}">Ø§Ù„Ø®Ø§Ù…Ø©:</label>
          <input type="text" id="quality_${idx}" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø·Ù† ÙÙ„ØŒ DTYØŒ ÙØ³ÙƒÙˆØ²..." />

          <label for="qtyKg_${idx}">Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØº):</label>
          <input type="number" id="qtyKg_${idx}" placeholder="Ù…Ø«Ø§Ù„: 250" />

          <label for="date_${idx}">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</label>
          <input type="date" id="date_${idx}" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="status_${idx}">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</label>
          <select id="status_${idx}">
            <option value="Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„</option>
            <option value="ØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„">ØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„</option>
          </select>
        </div>
        <div class="col">
          <label for="notes_${idx}">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
          <textarea id="notes_${idx}" placeholder="Ù…Ø«Ø§Ù„: ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ù„ÙˆÙ†ØŒ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…ØµØ¨ØºØ©..."></textarea>
        </div>
      </div>
    `;

    mariagesContainer.appendChild(wrapper);

    const dateInput = document.getElementById(`date_${idx}`);
    dateInput.value = todayISO();

    const fileInput = document.getElementById(`mariageImage_${idx}`);
    const preview = document.getElementById(`mariagePreview_${idx}`);

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) {
        preview.style.display = "none";
        preview.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    });
  }

  addMariageBtn.addEventListener("click", () => createMariageGroup());

  /************* 3) Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© *************/
  async function uploadImageToSupabase(file, designCode, mariageNumber) {
    if (!file) return null;

    const cleanDesign = designCode || "no-design";
    const cleanMariage = mariageNumber || "no-mariage";
    const fileExt = file.name.split(".").pop();
    const path = `printed/${cleanDesign}/m${cleanMariage}_${Date.now()}.${fileExt}`;

    const { data, error } = await supabaseClient
      .storage
      .from(STORAGE_BUCKET)
      .upload(path, file);

    if (error) {
      console.error("Storage upload error:", error);
      throw error;
    }

    const { data: publicData } = supabaseClient
      .storage
      .from(STORAGE_BUCKET)
      .getPublicUrl(path);

    return publicData.publicUrl || null;
  }

  /************* 4) Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø±ÙŠØ§Ø¬Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ printed_mariages *************/
  async function saveAllMariages() {
    const designCode = document.getElementById("designCode").value.trim();
    const screensCountStr = document.getElementById("screensCount").value.trim();
    const screensCount = screensCountStr ? Number(screensCountStr) : null;

    if (!designCode) {
      formMessage.textContent = "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… / ÙƒÙˆØ¯ Ø§Ù„Ø±Ø³Ù…Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰.";
      formMessage.className = "msg error";
      return;
    }

    const groups = Array.from(document.querySelectorAll(".mariage-group"));
    if (!groups.length) {
      formMessage.textContent = "Ø£Ø¶ÙŠÙÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø±ÙŠØ§Ø¬ ÙˆØ§Ø­Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.";
      formMessage.className = "msg error";
      return;
    }

    saveAllBtn.disabled = true;
    addMariageBtn.disabled = true;
    formMessage.textContent = "Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙŠØ§Ø¬Ø§Øª...";
    formMessage.className = "msg";

    try {
      for (const group of groups) {
        const idx = group.dataset.index;

        const mariageNumber = document.getElementById(`mariageNumber_${idx}`).value.trim();
        const printType = document.getElementById(`printType_${idx}`).value || null;
        const groundPrep = document.getElementById(`groundPrep_${idx}`).value || null;
        const quality = document.getElementById(`quality_${idx}`).value.trim();
        const qtyStr = document.getElementById(`qtyKg_${idx}`).value.trim();
        const qtyKg = qtyStr ? Number(qtyStr) : null;
        const dateVal = document.getElementById(`date_${idx}`).value || todayISO();
        const status = document.getElementById(`status_${idx}`).value || "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„";
        const notes = document.getElementById(`notes_${idx}`).value.trim();
        const fileInput = document.getElementById(`mariageImage_${idx}`);
        const file = fileInput.files[0];

        const hasAny =
          mariageNumber || printType || groundPrep || quality ||
          qtyKg || notes || file || dateVal !== todayISO() || status !== "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„";

        if (!hasAny) continue;

        let imageUrl = null;
        if (file) {
          imageUrl = await uploadImageToSupabase(file, designCode, mariageNumber || idx);
        }

        // ğŸŸ¢ Ù‡Ù†Ø§ Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„: Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Supabase (snake_case)
        const insertObj = {
          design_code: designCode,
          screens_count: screensCount,
          mariage_number: mariageNumber || String(idx),
          print_type: printType,
          ground_prep: groundPrep,
          quality: quality || null,
          qty_kg: qtyKg,
          date: dateVal,
          status: status,
          notes: notes || null,
          image_url: imageUrl
        };

        const { error } = await supabaseClient
          .from(TABLE_NAME)
          .insert([insertObj]);

        if (error) {
          console.error("Insert error:", error);
          throw error;
        }
      }

      formMessage.textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙŠØ§Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…";
      formMessage.className = "msg ok";

      document.getElementById("designCode").value = "";
      document.getElementById("screensCount").value = "";
      mariagesContainer.innerHTML = "";
      mariageCounter = 0;
      createMariageGroup();

      await loadPrintedTable();

      setTimeout(() => {
        formMessage.textContent = "";
      }, 2500);
    } catch (e) {
      console.error(e);
      formMessage.textContent = "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + (e?.message || "ØªÙÙ‚Ø¯ÙŠ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase.");
      formMessage.className = "msg error";
    } finally {
      saveAllBtn.disabled = false;
      addMariageBtn.disabled = false;
    }
  }

  saveAllBtn.addEventListener("click", saveAllMariages);

  /************* 5) ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø§Øª *************/
  const printedTableBody = document.getElementById("printedTableBody");
  const tableMessage = document.getElementById("tableMessage");
  const totalsInfo = document.getElementById("totalsInfo");

  async function loadPrintedTable() {
    tableMessage.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
    tableMessage.className = "msg";

    const { data, error } = await supabaseClient
      .from(TABLE_NAME)
      .select("*")
      .order("date", { ascending: false })
      .order("id", { ascending: false });

    if (error) {
      console.error(error);
      tableMessage.textContent = "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + (error.message || "");
      tableMessage.className = "msg error";
      return;
    }

    printedTableBody.innerHTML = "";
    let totalQty = 0;
    let count = 0;

    data.forEach((row, index) => {
      count++;
      if (row.qty_kg) totalQty += Number(row.qty_kg);

      let statusClass = "status-not";
      if (row.status === "ØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„") statusClass = "status-printed";
      if (row.status === "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…") statusClass = "status-received";

      let actionsHtml = `
        <button class="small-btn edit" data-id="${row.id}" data-action="edit">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="small-btn delete" data-id="${row.id}" data-action="delete">Ø­Ø°Ù</button>
      `;

      if (row.status === "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„") {
        actionsHtml =
          `<button class="small-btn action1" data-id="${row.id}" data-action="mark-printed">ØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„</button>` +
          actionsHtml;
      } else if (row.status === "ØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„") {
        actionsHtml =
          `<button class="small-btn action2" data-id="${row.id}" data-action="mark-received">ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</button>` +
          actionsHtml;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${row.image_url ? `<img src="${row.image_url}" class="printed-table-img" alt="Ù…Ø±ÙŠØ§Ø¬" />` : "â€”"}</td>
        <td>${row.design_code || "â€”"}</td>
        <td>${row.screens_count ?? "â€”"}</td>
        <td>${row.mariage_number || "â€”"}</td>
        <td>${row.print_type || "â€”"}</td>
        <td>${row.ground_prep || "â€”"}</td>
        <td>${row.quality || "â€”"}</td>
        <td>${row.qty_kg ?? "â€”"}</td>
        <td>${row.date || "â€”"}</td>
        <td><span class="status-pill ${statusClass}">${row.status || "â€”"}</span></td>
        <td>${row.notes || "â€”"}</td>
        <td>${actionsHtml}</td>
      `;
      printedTableBody.appendChild(tr);
    });

    totalsInfo.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙŠØ§Ø¬Ø§Øª: ${count} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©: ${totalQty || 0} ÙƒØº`;
    tableMessage.textContent = "";
  }

  /************* 6) Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„ / ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù) *************/
  async function updateRowStatus(id, newStatus, extraFields = {}) {
    const payload = Object.assign({}, extraFields, { status: newStatus });

    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .update(payload)
      .eq("id", id);

    if (error) {
      console.error(error);
      alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: " + (error.message || ""));
    } else {
      await loadPrintedTable();
    }
  }

  async function deleteRow(id) {
    const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ§Ø¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ");
    if (!ok) return;
    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .delete()
      .eq("id", id);

    if (error) {
      console.error(error);
      alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù: " + (error.message || ""));
    } else {
      await loadPrintedTable();
    }
  }

  async function editRowSimple(id) {
    const qtyNew = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±ÙƒÙŠÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±):");
    const notesNew = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±ÙƒÙŠÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±):");

    const payload = {};
    if (qtyNew !== null && qtyNew.trim() !== "") payload.qty_kg = Number(qtyNew);
    if (notesNew !== null && notesNew.trim() !== "") payload.notes = notesNew.trim();

    if (Object.keys(payload).length === 0) return;

    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .update(payload)
      .eq("id", id);

    if (error) {
      console.error(error);
      alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + (error.message || ""));
    } else {
      await loadPrintedTable();
    }
  }

  printedTableBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button.small-btn");
    if (!btn) return;

    const id = btn.dataset.id;
    const action = btn.dataset.action;
    if (!id || !action) return;

    if (action === "delete") {
      deleteRow(id);
    } else if (action === "mark-printed") {
      updateRowStatus(id, "ØªÙ… Ø§Ù„ØªØ´ÙƒÙŠÙ„", { printed_at: new Date().toISOString() });
    } else if (action === "mark-received") {
      updateRowStatus(id, "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…", { received_at: new Date().toISOString() });
    } else if (action === "edit") {
      editRowSimple(id);
    }
  });

  /************* 7) ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© *************/
  (async function init() {
    createMariageGroup();
    await loadPrintedTable();
  })();
</script>
</body>
</html>

