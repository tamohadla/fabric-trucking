<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تشكيلات القماش المطبوع</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f7;
      color: #111827;
    }
    header {
      background: #111827;
      color: #fff;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 18px; }
    nav { display: flex; gap: 6px; flex-wrap: wrap; }
    nav a {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      text-decoration: none;
      background: #374151;
      color: #fff;
      white-space: nowrap;
    }
    nav a.active { background: #4b7bec; }

    .container {
      max-width: 1200px;
      margin: 20px auto 40px;
      padding: 0 16px;
    }
    .card {
      background: #fff;
      border-radius: 18px;
      padding: 20px 18px 24px;
      box-shadow: 0 12px 35px rgba(15,23,42,0.08);
      margin-bottom: 20px;
    }
    h2 { margin: 0 0 14px; font-size: 18px; }
    h3 { margin: 0 0 10px; font-size: 16px; }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      color: #4b5563;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 10px;
      background: #f9fafb;
    }
    textarea { resize: vertical; min-height: 40px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 220px; }
    button.primary {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #4b7bec;
      color: #fff;
      margin-top: 4px;
    }
    button.primary:disabled { opacity: 0.6; cursor: default; }
    .btn-secondary { background: #10b981; }

    .msg { margin-top: 8px; font-size: 13px; }
    .msg.error { color: #dc2626; }
    .msg.ok { color: #16a34a; }

    .printed-top-info {
      padding: 12px 14px;
      border-radius: 12px;
      background: #f3f4f6;
      margin-bottom: 16px;
    }
    .mariage-group {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 12px;
      margin-bottom: 10px;
      background: #f9fafb;
    }
    .mariage-group h4 { margin: 0 0 8px; font-size: 14px; color: #111827; }

    .file-input { font-size: 12px; margin-bottom: 6px; }
    .thumb {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      object-fit: cover;
      display: none;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead { background: #f3f4f6; }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }
    tr:nth-child(even) { background: #fcfcfd; }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 66px;
      min-height:120px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #fff;
    }
    .status-not { background: #f97373; }
    .status-printed { background: #0ea5e9; }
    .status-received { background: #22c55e; }

    .small-btn {
      padding: 4px 8px;
      gap: 4px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
	min-width: 80px;     /* الحد الأدنى */
 	 
 	 max-width: 100px;
      width: 100%;
      font-size: 14px;
      margin: 6px 2px;
      color: #000;
    }
    .small-btn.edit { background: #D3D3D3; }
    .small-btn.delete { background: #ef4444; }
    .small-btn.action1 { background: #D3D3D3; }
    .small-btn.action2 { background: #D3D3D3; }

    .printed-table-img {
      width: 150px;
      height: 150px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #e5e7eb;
    }

    .totals {
      margin-top: 8px;
      font-size: 13px;
      text-align: left;
      color: #111827;
    }

    /* Modal تعديل */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .image-modal-img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 20px 45px rgba(15,23,42,0.35);
    }
    .modal {
      background: #fff;
      border-radius: 18px;
      padding: 18px 18px 16px;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 45px rgba(15,23,42,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .modal-header h3 { margin: 0; font-size: 16px; }
    .modal-close {
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 20px;
      cursor: pointer;
    }

    .small-btn.repeat { background: #D3D3D3; }
    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
      margin-bottom: 10px;
    }
    .radio-row { display:flex; gap:10px; flex-wrap:wrap; margin: 6px 0 10px; }
    .radio-row label { display:flex; gap:6px; align-items:center; margin:0; color:#111827; font-size:13px;}
    .hidden { display:none !important; }


    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      nav {
        width: 100%;
        justify-content: flex-start;
      }
      table { font-size: 12px; }
      th, td { padding: 6px 4px; }
    }
  
/* Edit modal image controls */
.img-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
.img-row img{width:86px;height:86px;object-fit:cover;border-radius:10px;border:1px solid #e5e5e5;cursor:pointer}
.mini-note{font-size:12px;opacity:.8;margin-top:4px;line-height:1.4}

</style>
</head>
<body>
<header>
  <h1>تشكيلات القماش المطبوع</h1>
  <nav>
    <a href="index.html">قماش سادة</a>
    <a href="printed_2.html" class="active">قماش مطبوع</a>
  </nav>
</header>

<div class="container">
  <!-- بطاقة إدخال المرياجات -->
  <section class="card">
    <h2>إدخال / مراجعة مرياجات الرسمة</h2>

    <!-- بيانات الرسمة العامة -->
    <div class="printed-top-info">
      <div class="row">
        <div class="col">
          <label for="designCode">رقم / كود الرسمة:</label>
          <input id="designCode" type="text" class="normalize-digits"
                 inputmode="decimal" placeholder="مثال: 15000" />
        </div>
        <div class="col">
          <label for="screensCount">عدد الشبلونات:</label>
         <input id="screensCount" type="text" class="normalize-digits"
       inputmode="decimal" placeholder="مثال: 6" />

        </div>
      </div>
    </div>

    <!-- مجموعات المرياج -->
    <h3>مرياجات لهذه الرسمة</h3>
    <div id="mariagesContainer"></div>

    <button class="primary" id="addMariageBtn">إضافة مرياج جديد</button>
    <br /><br />
    <button class="primary btn-secondary" id="saveAllBtn">حفظ كل المرياجات</button>
    <div class="msg" id="formMessage"></div>
  </section>

  <!-- جدول التشكيلات -->
  <section class="card">
    <h2>جدول تشكيلات المطبوع</h2>

    <!-- أدوات البحث والفلترة والترتيب -->
    <div class="row" style="margin-bottom: 10px; gap: 10px; align-items: flex-end;">
      <div class="col">
        <label for="searchInput">بحث:</label>
        <input id="searchInput" type="text" class="normalize-digits"
               placeholder="بحث برقم الرسمة / رقم المرياج / الخامة / النوع..." />
      </div>
      <div class="col">
        <label for="statusFilter">فلترة حسب الحالة:</label>
        <select id="statusFilter">
          <option value="">كل الحالات</option>
          <option value="لم يتم التشكيل">لم يتم التشكيل</option>
          <option value="تم التشكيل">تم التشكيل</option>
          <option value="تم الاستلام">تم الاستلام</option>
        </select>
      </div>
      <div class="col">
        <label for="sortField">ترتيب حسب:</label>
        <select id="sortField">
          <option value="date_desc">تاريخ الطلب (من الأحدث)</option>
          <option value="date_asc">تاريخ الطلب (من الأقدم)</option>
          <option value="designcode_asc">رقم الرسمة (تصاعدي)</option>
          <option value="designcode_desc">رقم الرسمة (تنازلي)</option>
        </select>
      </div>
    </div>

    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>الصورة</th>
        <th>رقم الرسمة</th>
        <th>عدد الشبلونات</th>
        <th>رقم المرياج</th>
        <th>نوع الطباعة</th>
        <th>تحضير الأرضية</th>
        <th>الخامة</th>
        <th>الكمية (كغ)</th>
        <th>تاريخ الطلب</th>
        <th>حالة الطلب</th>
        <th>ملاحظات</th>
        <th>إجراءات</th>
      </tr>
      </thead>
      <tbody id="printedTableBody"></tbody>
    </table>

    <div class="totals" id="totalsInfo"></div>
    <div class="msg" id="tableMessage"></div>
  </section>
</div>

<!-- datalist للخامات -->
<datalist id="qualityList"></datalist>

<!-- مودال تعديل -->
<div id="editModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>تعديل بيانات المرياج</h3>
      <button class="modal-close" id="editModalClose">&times;</button>
    </div>
    <div id="editModalBody">
      <div class="row">
        <div class="col">
          <label for="edit_designcode">رقم / كود الرسمة:</label>
          <input id="edit_designcode" type="text" class="normalize-digits" />
        </div>
        <div class="col">
          <label for="edit_screenscount">عدد الشبلونات:</label>
          <input id="edit_screenscount" type="text" class="normalize-digits"
       inputmode="decimal" />

        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="edit_mariagenumber">رقم المرياج:</label>
          <input id="edit_mariagenumber" type="text" class="normalize-digits" />
        </div>
        <div class="col">
          <label for="edit_printtype">نوع الطباعة:</label>
          <select id="edit_printtype">
            <option value="">اختار النوع...</option>
            <option value="بجمنت">بجمنت</option>
            <option value="راكتف">راكتف</option>
            <option value="دسبسرس">دسبسرس</option>
            <option value="صباغة مع طباعة">صباغة مع طباعة</option>
            <option value="برناوت">برناوت</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="edit_groundprep">تحضير الأرضية:</label>
          <select id="edit_groundprep">
            <option value="">اختار...</option>
            <option value="أوفوايت">أوفوايت</option>
            <option value="أبيض">أبيض</option>
          </select>
        </div>
        <div class="col">
          <label for="edit_quality">الخامة:</label>
          <input id="edit_quality" type="text" class="quality-input" list="qualityList" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="edit_qtykg">الكمية (كغ):</label>
          <input id="edit_qtykg" type="text" class="normalize-digits" inputmode="decimal" />
        </div>
        <div class="col">
          <label for="edit_date">تاريخ الطلب:</label>
          <input id="edit_date" type="date" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="edit_status">حالة الطلب:</label>
          <select id="edit_status">
            <option value="لم يتم التشكيل">لم يتم التشكيل</option>
            <option value="تم التشكيل">تم التشكيل</option>
            <option value="تم الاستلام">تم الاستلام</option>
          </select>
        </div>
        <div class="col">
          <label for="edit_notes">ملاحظات:</label>
          <textarea id="edit_notes"></textarea>
        </div>
      </div>

      
      <div class="row">
        <div class="col">
          <label>صورة المرياج الحالية:</label>
          <div class="img-row">
            <img id="edit_currentImage" src="" alt="صورة المرياج الحالية" />
            <div>
              <button type="button" class="small-btn" id="edit_viewImageBtn">تكبير</button>
              <div class="mini-note" id="edit_imageHint">يمكنك اختيار صورة جديدة من الأسفل لتحديث صورة هذا المرياج.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="edit_imagefile">تحديث صورة المرياج (اختياري):</label>
          <input id="edit_imagefile" type="file" accept="image/*" />
          <div class="mini-note">إذا اخترت صورة جديدة سيتم رفعها إلى التخزين وتحديث رابط الصورة لهذا الطلب فقط.</div>
          <img id="edit_newImagePreview" src="" alt="معاينة الصورة الجديدة" style="display:none; margin-top:8px; max-width:220px; border-radius:12px; border:1px solid #e5e5e5;" />
        </div>
      </div>

<div style="text-align: left; margin-top: 6px;">
        <button class="primary" id="editSaveBtn">حفظ التعديلات</button>
      </div>
      <div class="msg" id="editMessage"></div>
    </div>
  </div>
</div>

<!-- مودال عرض صورة المرياج -->
<div id="imageModal" class="modal-backdrop">
  <img id="imageModalImg" class="image-modal-img" alt="صورة المرياج" />
</div>


<!-- مودال تكرار التشكيل -->
<div id="repeatModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>تكرار التشكيل</h3>
      <button class="modal-close" id="repeatModalClose">&times;</button>
    </div>

    <div class="row">
      <div class="col">
        <label for="rep_designcode">رقم / كود الرسمة:</label>
        <input id="rep_designcode" type="text" class="normalize-digits" readonly />
      </div>
      <div class="col">
        <label for="rep_screenscount">عدد الشبلونات:</label>
        <input id="rep_screenscount" type="text" class="normalize-digits" inputmode="decimal" readonly />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="rep_mariagenumber">رقم المرياج:</label>
        <input id="rep_mariagenumber" type="text" class="normalize-digits" readonly />
        <div class="hint">هذا الحقل ثابت في التكرار حسب طلبك.</div>
      </div>
      <div class="col">
        <label for="rep_date">تاريخ الطلب:</label>
        <input id="rep_date" type="date" readonly />
        <div class="hint">سيتم ضبطه تلقائياً بتاريخ اليوم.</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="rep_printtype">نوع الطباعة:</label>
        <select id="rep_printtype">
          <option value="">اختار النوع...</option>
          <option value="بجمنت">بجمنت</option>
          <option value="راكتف">راكتف</option>
          <option value="دسبسرس">دسبسرس</option>
          <option value="صباغة مع طباعة">صباغة مع طباعة</option>
          <option value="برناوت">برناوت</option>
        </select>
      </div>
      <div class="col">
        <label for="rep_groundprep">تحضير الأرضية:</label>
        <select id="rep_groundprep">
          <option value="">اختار...</option>
          <option value="أوفوايت">أوفوايت</option>
          <option value="أبيض">أبيض</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="rep_quality">الخامة:</label>
        <input id="rep_quality" type="text" class="quality-input" list="qualityList" />
      </div>
      <div class="col">
        <label for="rep_qtykg">الكمية (كغ):</label>
        <input id="rep_qtykg" type="text" class="normalize-digits" inputmode="decimal" />
      </div>
    </div>

    <div>
      <label>صورة الطلب:</label>
      <div class="radio-row">
        <label><input type="radio" name="rep_img_mode" value="same" checked /> استخدام نفس الصورة</label>
        <label><input type="radio" name="rep_img_mode" value="none" /> بدون صورة</label>
        <label><input type="radio" name="rep_img_mode" value="upload" /> رفع صورة جديدة</label>
      </div>

      <div id="rep_upload_wrap" class="hidden">
        <input class="file-input" type="file" accept="image/*" id="rep_image_file" />
        <img id="rep_image_preview" class="thumb" alt="معاينة" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="rep_notes">ملاحظات:</label>
        <textarea id="rep_notes" placeholder="فارغ افتراضياً في التكرار"></textarea>
      </div>
      <div class="col">
        <label for="rep_status">حالة الطلب:</label>
        <input id="rep_status" type="text" value="تم التشكيل" readonly />
        <div class="hint">سيتم ضبط الحالة تلقائياً: تم التشكيل.</div>
      </div>
    </div>

    <div style="text-align:left; margin-top: 6px;">
      <button class="primary" id="repeatConfirmBtn">تأكيد التكرار</button>
      <button class="primary" id="repeatCancelBtn" style="background:#6b7280;">إلغاء</button>
    </div>
    <div class="msg" id="repeatMessage"></div>
  </div>
</div>


<!-- Supabase JS v2 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  /************* 1) إعداد Supabase *************/
  const SUPABASE_URL = "https://umrczwoxjhxwvrezocrm.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtcmN6d294amh4d3ZyZXpvY3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5ODA0MTUsImV4cCI6MjA3OTU1NjQxNX0.88PDM2h93rhGhOxVRDa5q3rismemqJJEpmBdwWmfgVQ"; // حطي الـ anon key تبعك هنا لو مو موجود
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const STORAGE_BUCKET = "images";
  const TABLE_NAME = "printed_mariages";

  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  /************* 2) تحويل الأرقام الهندية إلى عادية *************/
  function normalizeArabicDigits(str) {
    if (!str) return str;
    const map = {
      "٠": "0","١": "1","٢": "2","٣": "3","٤": "4",
      "٥": "5","٦": "6","٧": "7","٨": "8","٩": "9"
    };
    return String(str).replace(/[٠-٩]/g, ch => map[ch] ?? ch);
  }

  function setupDigitNormalization() {
    const inputs = document.querySelectorAll(".normalize-digits");
    inputs.forEach(input => {
      if (input.dataset.digitNormalized === "1") return;
      input.dataset.digitNormalized = "1";
      input.addEventListener("input", () => {
        const current = input.value;
        const normalized = normalizeArabicDigits(current);
        if (normalized !== current) {
          const pos = input.selectionStart;
          input.value = normalized;
          try { input.setSelectionRange(pos, pos); } catch (e) {}
        }
      });
    });
  }

  /************* 3) تصغير وضغط الصور قبل الرفع *************/
  async function resizeImageFile(file, maxSize = 800) {
    return new Promise((resolve, reject) => {
      if (!file || !file.type || !file.type.startsWith("image/")) {
        resolve(file);
        return;
      }
      const img = new Image();
      const reader = new FileReader();

      reader.onload = e => { img.src = e.target.result; };
      reader.onerror = err => reject(err);

      img.onload = () => {
        let width = img.width;
        let height = img.height;
        if (width <= maxSize && height <= maxSize) {
          resolve(file);
          return;
        }
        const scale = Math.min(maxSize / width, maxSize / height);
        const newWidth = Math.round(width * scale);
        const newHeight = Math.round(height * scale);

        const canvas = document.createElement("canvas");
        canvas.width = newWidth;
        canvas.height = newHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, newWidth, newHeight);

        canvas.toBlob(
          blob => {
            if (!blob) {
              resolve(file);
              return;
            }
            const compressedFile = new File(
              [blob],
              (file.name.split(".")[0] || "image") + ".jpg",
              { type: "image/jpeg" }
            );
            resolve(compressedFile);
          },
          "image/jpeg",
          0.8
        );
      };
      img.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  async function uploadImageToSupabase(file, designCode, mariageNumber) {
    if (!file) return null;
    let resizedFile;
    try {
      resizedFile = await resizeImageFile(file, 800);
    } catch (e) {
      console.warn("فشل تصغير الصورة، سيتم رفع الأصلية", e);
      resizedFile = file;
    }

    const cleanDesign = designCode || "no-design";
    const cleanMariage = mariageNumber || "no-mariage";
    const fileExt = resizedFile.name.split(".").pop();
    const path = `printed/${cleanDesign}/m${cleanMariage}_${Date.now()}.${fileExt}`;

const { error } = await supabaseClient
      .storage
      .from(STORAGE_BUCKET)
      .upload(path, resizedFile);

    if (error) {
      console.error("Storage upload error:", error);
      throw error;
    }

    const { data: publicData } = supabaseClient
      .storage
      .from(STORAGE_BUCKET)
      .getPublicUrl(path);

    return publicData?.publicUrl || null;
  }

  function extractStoragePathFromPublicUrl(url) {
    if (!url) return null;
    const marker = `/storage/v1/object/public/${STORAGE_BUCKET}/`;
    const idx = url.indexOf(marker);
    if (idx === -1) return null;
    return url.substring(idx + marker.length);
  }

  /************* 4) إدارة مجموعات المرياج في النموذج *************/
  const mariagesContainer = document.getElementById("mariagesContainer");
  const addMariageBtn = document.getElementById("addMariageBtn");
  const saveAllBtn = document.getElementById("saveAllBtn");
  const formMessage = document.getElementById("formMessage");

  let mariageCounter = 0;

  function createMariageGroup() {
    mariageCounter++;
    const idx = mariageCounter;

    const wrapper = document.createElement("div");
    wrapper.className = "mariage-group";
    wrapper.dataset.index = idx;

    wrapper.innerHTML = `
      <h4>مرياج رقم ${idx}</h4>
      <div class="row">
        <div class="col">
          <label>صورة المرياج (ملف أو كاميرا):</label>
          <input class="file-input" type="file" accept="image/*" 
                 id="mariageImage_${idx}" />
          <img id="mariagePreview_${idx}" class="thumb" alt="معاينة المرياج" />
        </div>
        <div class="col">
          <label for="mariageNumber_${idx}">رقم المرياج:</label>
          <input type="text" id="mariageNumber_${idx}" class="normalize-digits"
                 placeholder="مثال: 1، 2، 3..." />

          <label for="printType_${idx}">نوع الطباعة:</label>
          <select id="printType_${idx}">
            <option value="بجمنت">بجمنت</option>
            <option value="راكتف">راكتف</option>
            <option value="دسبسرس">دسبسرس</option>
            <option value="صباغة مع طباعة">صباغة مع طباعة</option>
            <option value="برناوت">برناوت</option>
          </select>

          <label for="groundPrep_${idx}">تحضير الأرضية:</label>
          <select id="groundPrep_${idx}">
            <option value="أوفوايت">أوفوايت</option>
            <option value="أبيض">أبيض</option>
          </select>
        </div>
        <div class="col">
          <label for="quality_${idx}">الخامة:</label>
          <input type="text" id="quality_${idx}" class="quality-input"
                 list="qualityList" placeholder="مثال: قطن فل، DTY، فسكوز..." />

          <label for="qtyKg_${idx}">الكمية (كغ):</label>
          <input type="text" id="qtyKg_${idx}" class="normalize-digits"
                 inputmode="decimal" placeholder="مثال: 250" />

          <label for="date_${idx}">تاريخ الطلب:</label>
          <input type="date" id="date_${idx}" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="status_${idx}">حالة الطلب:</label>
          <select id="status_${idx}">
            <option value="تم التشكيل">تم التشكيل</option>
            <option value="لم يتم التشكيل">لم يتم التشكيل</option>
            
          </select>
        </div>
        <div class="col">
          <label for="notes_${idx}">ملاحظات:</label>
          <textarea id="notes_${idx}" placeholder="مثال: تعديل بسيط في اللون، ملاحظة للمصبغة..."></textarea>
        </div>
      </div>
    `;

    mariagesContainer.appendChild(wrapper);

    // تعبئة التاريخ + تحضير الأرضية الافتراضي
    const dateInput = document.getElementById(`date_${idx}`);
    dateInput.value = todayISO();
    const groundSel = document.getElementById(`groundPrep_${idx}`);
    groundSel.value = "أوفوايت";

    // معاينة الصورة
    const fileInput = document.getElementById(`mariageImage_${idx}`);
    const preview = document.getElementById(`mariagePreview_${idx}`);
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) {
        preview.style.display = "none";
        preview.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    });

    setupDigitNormalization();
  }

  addMariageBtn.addEventListener("click", () => createMariageGroup());

  /************* 5) حفظ المرياجات *************/
  async function saveAllMariages() {
    const designCodeInput = document.getElementById("designCode");
    const screensCountInput = document.getElementById("screensCount");
    designCodeInput.value = normalizeArabicDigits(designCodeInput.value);
    screensCountInput.value = normalizeArabicDigits(screensCountInput.value);

    const designCode = designCodeInput.value.trim();
    const screensCountStr = screensCountInput.value.trim();
    const screensCount = screensCountStr ? Number(screensCountStr) : null;

    if (!designCode) {
      formMessage.textContent = "من فضلك أدخلي رقم / كود الرسمة في الأعلى.";
      formMessage.className = "msg error";
      return;
    }

    const groups = Array.from(document.querySelectorAll(".mariage-group"));
    if (!groups.length) {
      formMessage.textContent = "أضيفي على الأقل مرياج واحد قبل الحفظ.";
      formMessage.className = "msg error";
      return;
    }

    saveAllBtn.disabled = true;
    addMariageBtn.disabled = true;
    formMessage.textContent = "جاري حفظ المرياجات...";
    formMessage.className = "msg";

    try {
      for (const group of groups) {
        const idx = group.dataset.index;

        const mariageNumberInput = document.getElementById(`mariageNumber_${idx}`);
        const qtyInput = document.getElementById(`qtyKg_${idx}`);

        mariageNumberInput.value = normalizeArabicDigits(mariageNumberInput.value);
        qtyInput.value = normalizeArabicDigits(qtyInput.value);

        const mariageNumber = mariageNumberInput.value.trim();
        const printType = document.getElementById(`printType_${idx}`).value || null;
        const groundPrep = document.getElementById(`groundPrep_${idx}`).value || null;
        const quality = document.getElementById(`quality_${idx}`).value.trim();
        const qtyStr = qtyInput.value.trim();
        const qtyKg = qtyStr ? Number(qtyStr) : null;
        const dateVal = document.getElementById(`date_${idx}`).value || todayISO();
        const status = document.getElementById(`status_${idx}`).value || "لم يتم التشكيل";
        const notes = document.getElementById(`notes_${idx}`).value.trim();
        const fileInput = document.getElementById(`mariageImage_${idx}`);
        const file = fileInput.files[0];

        const hasAny =
          mariageNumber || printType || groundPrep || quality ||
          qtyKg || notes || file || dateVal !== todayISO() || status !== "لم يتم التشكيل";

        if (!hasAny) continue;

        let imageUrl = null;
        if (file) {
          imageUrl = await uploadImageToSupabase(file, designCode, mariageNumber || idx);
        }

        const insertObj = {
          designcode: designCode,
          screenscount: screensCount,
          mariagenumber: mariageNumber || String(idx),
          printtype: printType,
          groundprep: groundPrep,
          quality: quality || null,
          qtykg: qtyKg,
          date: dateVal,
          status,
          notes: notes || null,
          imageurl: imageUrl
        };

        const { error } = await supabaseClient
          .from(TABLE_NAME)
          .insert([insertObj]);

        if (error) {
          console.error("Insert error:", error);
          throw error;
        }
      }

      formMessage.textContent = "تم حفظ المرياجات بنجاح ✅";
      formMessage.className = "msg ok";

      document.getElementById("designCode").value = "";
      document.getElementById("screensCount").value = "";
      mariagesContainer.innerHTML = "";
      mariageCounter = 0;
      createMariageGroup();

      await loadPrintedTable();
      updateQualityDatalist();

      setTimeout(() => { formMessage.textContent = ""; }, 2500);
    } catch (e) {
      console.error(e);
      formMessage.textContent = "حدث خطأ أثناء الحفظ. تأكدي من اتصال الإنترنت وسياسات Supabase.";
      formMessage.className = "msg error";
    } finally {
      saveAllBtn.disabled = false;
      addMariageBtn.disabled = false;
    }
  }

  saveAllBtn.addEventListener("click", saveAllMariages);

  /************* 6) تحميل الجدول + رندر مع البحث والفلترة *************/
  const printedTableBody = document.getElementById("printedTableBody");
  const tableMessage = document.getElementById("tableMessage");
  const totalsInfo = document.getElementById("totalsInfo");
  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");
  const sortField = document.getElementById("sortField");

  let printedData = [];

  async function loadPrintedTable() {
    tableMessage.textContent = "جاري تحميل البيانات...";
    tableMessage.className = "msg";

    const { data, error } = await supabaseClient
      .from(TABLE_NAME)
      .select("*")
      .order("date", { ascending: false })
      .order("designcode", { ascending: true })
      .order("mariagenumber", { ascending: true });

    if (error) {
      console.error(error);
      tableMessage.textContent = "حدث خطأ أثناء تحميل البيانات.";
      tableMessage.className = "msg error";
      return;
    }

    printedData = data || [];
    renderPrintedTable();
    updateQualityDatalist();
    tableMessage.textContent = "";
  }

  function applyFiltersAndSort() {
    let rows = printedData.slice();

    const q = normalizeArabicDigits(searchInput.value.trim());
    if (q) {
      const qq = q.toLowerCase();
      rows = rows.filter(row => {
        return (
          (row.designcode || "").toLowerCase().includes(qq) ||
          (row.mariagenumber || "").toLowerCase().includes(qq) ||
          (row.quality || "").toLowerCase().includes(qq) ||
          (row.printtype || "").toLowerCase().includes(qq) ||
          (row.groundprep || "").toLowerCase().includes(qq)
        );
      });
    }

    const statusVal = statusFilter.value;
    if (statusVal) {
      rows = rows.filter(row => row.status === statusVal);
    }

    const sf = sortField.value;
    if (sf === "date_asc") {
      rows.sort((a, b) => {
        const da = a.date || "";
        const db = b.date || "";
        const cmp = da.localeCompare(db);
        if (cmp !== 0) return cmp;
        return (a.designcode || "").localeCompare(b.designcode || "");
      });
    } else if (sf === "date_desc") {
      rows.sort((a, b) => {
        const da = a.date || "";
        const db = b.date || "";
        const cmp = db.localeCompare(da);
        if (cmp !== 0) return cmp;
        return (a.designcode || "").localeCompare(b.designcode || "");
      });
    } else if (sf === "designcode_asc") {
      rows.sort((a, b) => (a.designcode || "").localeCompare(b.designcode || ""));
    } else if (sf === "designcode_desc") {
      rows.sort((a, b) => (b.designcode || "").localeCompare(a.designcode || ""));
    }

    return rows;
  }

  function renderPrintedTable() {
    const rows = applyFiltersAndSort();
    printedTableBody.innerHTML = "";

    let totalQty = 0;
    let count = 0;

    rows.forEach((row, index) => {
      count++;
      if (row.qtykg) totalQty += Number(row.qtykg);

      let statusClass = "status-not";
      if (row.status === "تم التشكيل") statusClass = "status-printed";
      if (row.status === "تم الاستلام") statusClass = "status-received";

      let actionsHtml = `
        <button class="small-btn repeat" data-id="${row.id}" data-action="repeat">تكرار</button>
        <button class="small-btn edit" data-id="${row.id}" data-action="edit">تعديل</button>
        <button class="small-btn delete" data-id="${row.id}" data-action="delete">حذف</button>
      `;

      if (row.status === "لم يتم التشكيل") {
        actionsHtml =
          `<button class="small-btn action1" data-id="${row.id}" data-action="mark-printed">تم التشكيل</button>` +
          actionsHtml;
      } else if (row.status === "تم التشكيل") {
        actionsHtml =
          `<button class="small-btn action2" data-id="${row.id}" data-action="mark-received">تم الاستلام</button>` +
          actionsHtml;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${row.imageurl ? `<img src="${row.imageurl}" class="printed-table-img" alt="مرياج" />` : "—"}</td>
        <td>${row.designcode || "—"}</td>
        <td>${row.screenscount ?? "—"}</td>
        <td>${row.mariagenumber || "—"}</td>
        <td>${row.printtype || "—"}</td>
        <td>${row.groundprep || "—"}</td>
        <td>${row.quality || "—"}</td>
        <td>${row.qtykg ?? "—"}</td>
        <td>${row.date || "—"}</td>
        <td><span class="status-pill ${statusClass}">${row.status || "—"}</span></td>
        <td>${row.notes || "—"}</td>
        <td>${actionsHtml}</td>
      `;
      printedTableBody.appendChild(tr);
    });

    totalsInfo.textContent = `إجمالي عدد المرياجات: ${count} | إجمالي الكمية: ${totalQty || 0} كغ`;
  }

  searchInput.addEventListener("input", () => { renderPrintedTable(); });
  statusFilter.addEventListener("change", () => { renderPrintedTable(); });
  sortField.addEventListener("change", () => { renderPrintedTable(); });

  /************* 7) أوتوكمبليت للخامة *************/
  function updateQualityDatalist() {
    const dl = document.getElementById("qualityList");
    if (!dl) return;
    const set = new Set();
    printedData.forEach(row => {
      if (row.quality) set.add(row.quality);
    });
    const inputs = document.querySelectorAll(".quality-input");
    inputs.forEach(i => {
      const v = i.value && i.value.trim();
      if (v) set.add(v);
    });
    dl.innerHTML = "";
    Array.from(set).forEach(q => {
      const opt = document.createElement("option");
      opt.value = q;
      dl.appendChild(opt);
    });
  }

  /************* 8) أزرار الجدول: حالة / حذف / تعديل *************/
  async function updateRowStatus(id, newStatus, dateField) {
    const payload = { status: newStatus };
    const nowIso = new Date().toISOString();
    if (dateField === "printedat") payload.printedat = nowIso;
    if (dateField === "receivedat") payload.receivedat = nowIso;

    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .update(payload)
      .eq("id", id);

    if (error) {
      console.error(error);
      alert("لم يتم تحديث الحالة. تحققي من الاتصال وسياسات Supabase.");
    } else {
      await loadPrintedTable();
    }
  }

  async function deleteRow(id) {
    const row = printedData.find(r => r.id === id);
    const ok = confirm("هل تريدين حذف هذا المرياج نهائياً؟");
    if (!ok) return;

    // خيار (2): حذف الصورة فقط إذا لم تعد مستخدمة في أي سجل آخر
    let imagePath = null;
    let imageRefCount = 0;

    try {
      if (row && row.imageurl) {
        imagePath = extractStoragePathFromPublicUrl(row.imageurl);
        if (imagePath) {
          const { count, error: countErr } = await supabaseClient
            .from(TABLE_NAME)
            .select("id", { count: "exact", head: true })
            .eq("imageurl", row.imageurl);

          if (countErr) {
            console.warn("تعذر حساب استخدام الصورة:", countErr);
          } else {
            imageRefCount = count || 0;
          }
        }
      }
    } catch (e) {
      console.warn("تعذر حساب استخدام الصورة:", e);
    }

    // حذف السجل أولاً
    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .delete()
      .eq("id", id);

    if (error) {
      console.error(error);
      alert("لم يتم الحذف.");
      return;
    }

    // إذا كان هذا السجل هو الوحيد الذي يستخدم الصورة، احذف الصورة من التخزين
    try {
      if (imagePath && imageRefCount === 1) {
        const { error: rmErr } = await supabaseClient.storage.from(STORAGE_BUCKET).remove([imagePath]);
        if (rmErr) console.warn("خطأ أثناء حذف الصورة من التخزين:", rmErr);
      }
    } catch (e) {
      console.warn("خطأ أثناء حذف الصورة من التخزين:", e);
    }

    await loadPrintedTable();
  }

  /************* 9) مودال التعديل الكامل *************/
  const editModalBackdrop = document.getElementById("editModalBackdrop");
  const editModalClose = document.getElementById("editModalClose");
  const editSaveBtn = document.getElementById("editSaveBtn");
  const editMessage = document.getElementById("editMessage");

  const editImageFile = document.getElementById("edit_imagefile");
  const editCurrentImage = document.getElementById("edit_currentImage");
  const editViewImageBtn = document.getElementById("edit_viewImageBtn");
  const editNewImagePreview = document.getElementById("edit_newImagePreview");


  let currentEditRow = null;

  if (editImageFile) {
    editImageFile.addEventListener("change", () => {
      const f = editImageFile.files && editImageFile.files[0];
      if (!f) {
        if (editNewImagePreview) { editNewImagePreview.style.display = "none"; editNewImagePreview.src = ""; }
        return;
      }
      const url = URL.createObjectURL(f);
      if (editNewImagePreview) { editNewImagePreview.src = url; editNewImagePreview.style.display = "block"; }
    });
  }

  if (editViewImageBtn) {
    editViewImageBtn.addEventListener("click", () => {
      if (!editCurrentImage || !editCurrentImage.src) return;
      const imageModal = document.getElementById("imageModal");
      const imageModalImg = document.getElementById("imageModalImg");
      imageModalImg.src = editCurrentImage.src;
      imageModal.style.display = "flex";
    });
  }



  /************* 9.5) مودال تكرار التشكيل *************/
  const repeatModalBackdrop = document.getElementById("repeatModalBackdrop");
  const repeatModalClose = document.getElementById("repeatModalClose");
  const repeatConfirmBtn = document.getElementById("repeatConfirmBtn");
  const repeatCancelBtn = document.getElementById("repeatCancelBtn");
  const repeatMessage = document.getElementById("repeatMessage");

  let currentRepeatRow = null;

  function getRepeatImageMode() {
    const el = document.querySelector('input[name="rep_img_mode"]:checked');
    return el ? el.value : "same";
  }

  function setRepeatUploadVisibility() {
    const mode = getRepeatImageMode();
    const wrap = document.getElementById("rep_upload_wrap");
    if (!wrap) return;
    if (mode === "upload") wrap.classList.remove("hidden");
    else wrap.classList.add("hidden");
  }

  // معاينة صورة التكرار
  const repImageFile = document.getElementById("rep_image_file");
  const repImagePreview = document.getElementById("rep_image_preview");
  if (repImageFile) {
    repImageFile.addEventListener("change", () => {
      const file = repImageFile.files && repImageFile.files[0];
      if (!file) {
        repImagePreview.style.display = "none";
        repImagePreview.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        repImagePreview.src = e.target.result;
        repImagePreview.style.display = "block";
      };
      reader.readAsDataURL(file);
    });
  }

  document.querySelectorAll('input[name="rep_img_mode"]').forEach(r => {
    r.addEventListener("change", setRepeatUploadVisibility);
  });

  function openRepeatModal(id) {
    const row = printedData.find(r => r.id === id);
    if (!row) return;
    currentRepeatRow = row;

    // حقول ثابتة (readonly)
    document.getElementById("rep_designcode").value = row.designcode || "";
    document.getElementById("rep_screenscount").value = row.screenscount ?? "";
    document.getElementById("rep_mariagenumber").value = row.mariagenumber || "";
    document.getElementById("rep_date").value = todayISO();

    // حقول منسوخة (قابلة للتعديل إن أردت)
    document.getElementById("rep_printtype").value = row.printtype || "";
    document.getElementById("rep_groundprep").value = row.groundprep || "أوفوايت";
    document.getElementById("rep_quality").value = row.quality || "";
    document.getElementById("rep_qtykg").value = row.qtykg ?? "";

    // افتراضي: ملاحظات فارغة + حالة تم التشكيل
    document.getElementById("rep_notes").value = "";
    document.getElementById("rep_status").value = "تم التشكيل";

    // الصورة: افتراضي نفس الصورة
    const sameRadio = document.querySelector('input[name="rep_img_mode"][value="same"]');
    if (sameRadio) sameRadio.checked = true;
    if (repImageFile) repImageFile.value = "";
    if (repImagePreview) { repImagePreview.style.display = "none"; repImagePreview.src = ""; }
    setRepeatUploadVisibility();

    repeatMessage.textContent = "";
    repeatMessage.className = "msg";
    repeatModalBackdrop.style.display = "flex";
    setupDigitNormalization();
  }

  function closeRepeatModal() {
    repeatModalBackdrop.style.display = "none";
    currentRepeatRow = null;
    repeatMessage.textContent = "";
  }

  if (repeatModalClose) repeatModalClose.addEventListener("click", closeRepeatModal);
  if (repeatCancelBtn) repeatCancelBtn.addEventListener("click", closeRepeatModal);

  if (repeatModalBackdrop) {
    repeatModalBackdrop.addEventListener("click", (e) => {
      if (e.target === repeatModalBackdrop) closeRepeatModal();
    });
  }

  async function confirmRepeat() {
    if (!currentRepeatRow) return;

    // نعيد ضبط أرقام عربية
    const qtyInput = document.getElementById("rep_qtykg");
    qtyInput.value = normalizeArabicDigits(qtyInput.value);

    const payload = {
      designcode: (currentRepeatRow.designcode || "").trim(),
      screenscount: currentRepeatRow.screenscount ?? null,
      mariagenumber: (currentRepeatRow.mariagenumber || "").trim(),
      printtype: document.getElementById("rep_printtype").value || null,
      groundprep: document.getElementById("rep_groundprep").value || null,
      quality: document.getElementById("rep_quality").value.trim() || null,
      qtykg: qtyInput.value ? Number(qtyInput.value) : null,
      date: todayISO(),
      status: "تم التشكيل",
      notes: null,
      printedat: new Date().toISOString(),
      receivedat: null,
      imageurl: null
    };

    // ملاحظات: فارغ افتراضياً (إذا كتب المستخدم نأخذه)
    const notes = document.getElementById("rep_notes").value.trim();
    payload.notes = notes ? notes : null;

    // الصورة حسب الاختيار
    const mode = getRepeatImageMode();
    try {
      if (mode === "same") {
        payload.imageurl = currentRepeatRow.imageurl || null;
      } else if (mode === "none") {
        payload.imageurl = null;
      } else if (mode === "upload") {
        const file = repImageFile && repImageFile.files ? repImageFile.files[0] : null;
        if (file) {
          payload.imageurl = await uploadImageToSupabase(
            file,
            payload.designcode || "no-design",
            payload.mariagenumber || "no-mariage"
          );
        } else {
          payload.imageurl = null;
        }
      }
    } catch (e) {
      console.error(e);
      repeatMessage.textContent = "خطأ أثناء التعامل مع الصورة. جرّب مرة أخرى.";
      repeatMessage.className = "msg error";
      return;
    }

    repeatConfirmBtn.disabled = true;
    repeatCancelBtn.disabled = true;
    repeatMessage.textContent = "جاري إنشاء التكرار...";
    repeatMessage.className = "msg";

    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .insert([payload]);

    repeatConfirmBtn.disabled = false;
    repeatCancelBtn.disabled = false;

    if (error) {
      console.error(error);
      repeatMessage.textContent = "لم يتم إنشاء التكرار. تحقّق من اتصال الإنترنت وسياسات Supabase.";
      repeatMessage.className = "msg error";
      return;
    }

    repeatMessage.textContent = "تم إنشاء التكرار بنجاح ✅";
    repeatMessage.className = "msg ok";
    await loadPrintedTable();
    updateQualityDatalist();
    setTimeout(() => { closeRepeatModal(); }, 400);
  }

  if (repeatConfirmBtn) repeatConfirmBtn.addEventListener("click", confirmRepeat);


  function openEditModal(id) {
    const row = printedData.find(r => r.id === id);
    if (!row) return;
    currentEditRow = row;

    // تهيئة قسم الصورة في مودال التعديل
    if (editImageFile) editImageFile.value = "";
    if (editNewImagePreview) { editNewImagePreview.style.display = "none"; editNewImagePreview.src = ""; }
    if (editCurrentImage) {
      if (row.imageurl) {
        editCurrentImage.src = row.imageurl;
editCurrentImage.style.display = "block";
      } else {
        editCurrentImage.src = "";
        editCurrentImage.style.display = "none";
      }
    }


    document.getElementById("edit_designcode").value = row.designcode || "";
    document.getElementById("edit_screenscount").value = row.screenscount ?? "";
    document.getElementById("edit_mariagenumber").value = row.mariagenumber || "";
    document.getElementById("edit_printtype").value = row.printtype || "";
    document.getElementById("edit_groundprep").value = row.groundprep || "أوفوايت";
    document.getElementById("edit_quality").value = row.quality || "";
    document.getElementById("edit_qtykg").value = row.qtykg ?? "";
    document.getElementById("edit_date").value = row.date || todayISO();
    document.getElementById("edit_status").value = row.status || "لم يتم التشكيل";
    document.getElementById("edit_notes").value = row.notes || "";

    editMessage.textContent = "";
    editModalBackdrop.style.display = "flex";
    setupDigitNormalization();
  }

  function closeEditModal() {
    editModalBackdrop.style.display = "none";
    currentEditRow = null;
  }

  editModalClose.addEventListener("click", closeEditModal);
  editModalBackdrop.addEventListener("click", (e) => {
    if (e.target === editModalBackdrop) {
      closeEditModal();
    }
  });

  async function saveEditChanges() {
    if (!currentEditRow) return;

    const designcodeInput = document.getElementById("edit_designcode");
    const screenscountInput = document.getElementById("edit_screenscount");
    const mariagenumberInput = document.getElementById("edit_mariagenumber");
    const qtyInput = document.getElementById("edit_qtykg");
    const imageFileInput = document.getElementById("edit_imagefile");
    const newImageFile = imageFileInput && imageFileInput.files && imageFileInput.files[0] ? imageFileInput.files[0] : null;


    designcodeInput.value = normalizeArabicDigits(designcodeInput.value);
    screenscountInput.value = normalizeArabicDigits(screenscountInput.value);
    mariagenumberInput.value = normalizeArabicDigits(mariagenumberInput.value);
    qtyInput.value = normalizeArabicDigits(qtyInput.value);

    const payload = {
      designcode: designcodeInput.value.trim(),
      screenscount: screenscountInput.value ? Number(screenscountInput.value) : null,
      mariagenumber: mariagenumberInput.value.trim(),
      printtype: document.getElementById("edit_printtype").value || null,
      groundprep: document.getElementById("edit_groundprep").value || null,
      quality: document.getElementById("edit_quality").value.trim() || null,
      qtykg: qtyInput.value ? Number(qtyInput.value) : null,
      date: document.getElementById("edit_date").value || todayISO(),
      status: document.getElementById("edit_status").value,
      notes: document.getElementById("edit_notes").value.trim() || null
    };

    const oldStatus = currentEditRow.status || "لم يتم التشكيل";
    const newStatus = payload.status;

    if (newStatus === "تم التشكيل" && !currentEditRow.printedat) {
      payload.printedat = new Date().toISOString();
    }
    if (newStatus === "تم الاستلام" && !currentEditRow.receivedat) {
      payload.receivedat = new Date().toISOString();
    }

    editSaveBtn.disabled = true;
    editMessage.textContent = "جاري حفظ التعديلات...";
    editMessage.className = "msg";


    // تحديث/استبدال صورة المرياج (Overwrite) بحيث تكون موحّدة لكل الطلبات التي تشير لنفس الملف
    if (newImageFile) {
      try {
        let targetPath = null;

        // إذا كانت هناك صورة سابقة، سنقوم بالـ overwrite لنفس المسار
        if (currentEditRow.imageurl) {
          targetPath = extractStoragePathFromPublicUrl(currentEditRow.imageurl);
        }

        // إذا لم توجد صورة سابقة، ننشئ مسار ثابت مبني على رقم المرياج (موحّد)
        if (!targetPath) {
          const ext = (newImageFile.name && newImageFile.name.includes(".")) ? newImageFile.name.split(".").pop() : "jpg";
          const safeMariage = (payload.mariagenumber || "mariage").toString().replace(/[^0-9a-zA-Z_-]/g, "_");
          targetPath = `mariages/${safeMariage}.${ext}`;
        }

        const { error: upErr } = await supabaseClient
          .storage
          .from(STORAGE_BUCKET)
          .upload(targetPath, newImageFile, {
            upsert: true,
            contentType: newImageFile.type || "image/*",
            cacheControl: "3600"
          });

        if (upErr) {
          console.error(upErr);
          editMessage.textContent = "فشل تحديث الصورة. تحققي من صلاحيات التخزين.";
          editMessage.className = "msg error";
          editSaveBtn.disabled = false;
          return;
        }

        // لو لم يكن هناك رابط صورة سابق، نُثبت رابط عام جديد في DB
        if (!currentEditRow.imageurl) {
          const { data: pub } = supabaseClient.storage.from(STORAGE_BUCKET).getPublicUrl(targetPath);
          if (pub && pub.publicUrl) {
            payload.imageurl = pub.publicUrl;
          }
        } else {
          // نترك imageurl كما هو (نفس الرابط) لضمان التوحيد بين كل الطلبات
          payload.imageurl = currentEditRow.imageurl;
        }

        // لتفادي مشكلة الكاش في الواجهة: نحدّث زمن الطباعة (لا يضر) ليكون “آخر تحديث”
        payload.printedat = new Date().toISOString();

      } catch (e) {
        console.error(e);
        editMessage.textContent = "حدث خطأ غير متوقع أثناء تحديث الصورة.";
        editMessage.className = "msg error";
        editSaveBtn.disabled = false;
        return;
      }
    }

    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .update(payload)
      .eq("id", currentEditRow.id);

    editSaveBtn.disabled = false;

    if (error) {
      console.error(error);
      editMessage.textContent = "لم يتم الحفظ. تحققي من الاتصال.";
      editMessage.className = "msg error";
    } else {
      editMessage.textContent = "تم حفظ التعديلات بنجاح ✅";
      editMessage.className = "msg ok";
      await loadPrintedTable();
      setTimeout(() => { closeEditModal(); }, 400);
    }
  }

  editSaveBtn.addEventListener("click", saveEditChanges);

  printedTableBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button.small-btn");
    if (!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    if (!id || !action) return;

    if (action === "delete") {
      deleteRow(id);
    } else if (action === "mark-printed") {
      updateRowStatus(id, "تم التشكيل", "printedat");
    } else if (action === "mark-received") {
      updateRowStatus(id, "تم الاستلام", "receivedat");
    } else if (action === "edit") {
      openEditModal(id);
    } else if (action === "repeat") {
      openRepeatModal(id);
    }
  });

  // عرض صورة المرياج بحجم كبير عند الضغط عليها
  const imageModal = document.getElementById("imageModal");
  const imageModalImg = document.getElementById("imageModalImg");

  printedTableBody.addEventListener("click", (e) => {
    const img = e.target.closest(".printed-table-img");
    if (img) {
      imageModalImg.src = img.src;
      imageModal.style.display = "flex";
    }
  });

  imageModal.addEventListener("click", () => {
    imageModal.style.display = "none";
    imageModalImg.src = "";
  });

  /************* 10) التهيئة عند التحميل *************/
  (async function init() {
    createMariageGroup();
    setupDigitNormalization();
    await loadPrintedTable();
  })();
</script>
</body>
</html>




