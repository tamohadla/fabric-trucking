<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>متابعة طلبات القماش - سادة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f7;
      color: #111827;
    }

    header {
      background: #111827;
      color: #fff;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    nav {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    nav button {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      background: #374151;
      color: #fff;
      white-space: nowrap;
    }

    nav button.active {
      background: #4b7bec;
    }

    .container {
      max-width: 1100px;
      margin: 20px auto 40px;
      padding: 0 16px;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      padding: 18px 16px 22px;
      box-shadow: 0 12px 35px rgba(15,23,42,0.08);
      margin-bottom: 20px;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    h3 {
      margin: 6px 0 10px;
      font-size: 15px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      color: #4b5563;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 8px;
      background: #f9fafb;
    }

    /* محاولة تقريب حقل التاريخ من بقية الحقول */
    input[type="date"] {
      line-height: 1.2;
    }

    textarea {
      resize: vertical;
      min-height: 40px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .col {
      flex: 1;
      min-width: 220px;
    }

    .primary {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #4b7bec;
      color: #fff;
      margin-top: 4px;
    }

    .primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .msg {
      margin-top: 6px;
      font-size: 13px;
    }

    .info-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 7px 5px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
      white-space: nowrap;
    }

    tr:nth-child(even) {
      background: #fcfcfd;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 90px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
    }

    .status-lab {
      background: #f97316; /* تم طلب المخبريات */
    }

    .status-not-printed {
      background: #ef4444; /* لم يتم التشكيل */
    }

    .status-printed {
      background: #22c55e; /* تم التشكيل */
    }

    .status-received {
      background: #0ea5e9; /* تم الاستلام */
    }

    .small-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 11px;
      margin: 1px 0;
      color: #fff;
    }

    .small-btn.edit {
      background: #3b82f6;
    }

    .small-btn.delete {
      background: #ef4444;
    }

    .small-btn.lab-move {
      background: #10b981;
    }

    .small-btn.mark-printed {
      background: #f59e0b;
    }

    .small-btn.mark-received {
      background: #22c55e;
    }

    .small-btn.unreceive {
      background: #6b7280;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .filter-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }

    .filter-btn.active {
      background: #4b7bec;
      color: #fff;
      border-color: #4b7bec;
    }

    .filter-input {
      max-width: 180px;
    }

    .totals {
      margin-top: 6px;
      font-size: 13px;
      text-align: left;
      color: #111827;
    }

    /* خلية الإجراءات: الأزرار تحت بعض */
    .actions-cell {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 3px;
      min-width: 90px;
    }

    .actions-cell .small-btn {
      width: 100%;
    }

    /* خلية الرسمة تسمح بلف النص */
    .pattern-cell {
      white-space: normal;
      line-height: 1.4;
      max-width: 160px;
    }

    /* خلايا النصوص الطويلة (اللون، الخامة، لصالح مين) نسمح لها باللف */
    .wrap-cell {
      white-space: normal;
      line-height: 1.4;
    }

    /* تحسين العرض على الشاشات المتوسطة والصغيرة (آيفون + آيباد عمودي) */
    @media (max-width: 900px) {
      body {
        padding: 0 8px;
        font-size: 15px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      nav {
        margin-top: 6px;
        width: 100%;
        flex-wrap: wrap;
      }
      nav button {
        flex: 1 1 auto;
        text-align: center;
      }
      .container {
        max-width: 100%;
        margin: 10px auto 30px;
        padding: 0 4px 24px;
      }
      .row {
        flex-direction: column;      /* الحقول فوق بعض، عرض كامل */
        gap: 6px;
      }
      .card {
        padding: 14px 12px 16px;
        border-radius: 14px;
      }
      input[type="text"],
      input[type="number"],
      input[type="date"],
      select,
      textarea {
        font-size: 16px !important;
        padding: 10px 12px;
      }
      button,
      .primary {
        width: 100%;
        font-size: 15px;
        padding: 10px 12px;
      }
      table {
        display: block;
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
      th, td {
        padding: 8px 6px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>متابعة طلبات القماش - سادة</h1>
  <nav>
    <button id="nav-solid" class="active">قماش سادة</button>
    <button id="nav-printed" onclick="window.location.href='printed.html'">قماش مطبوع</button>
  </nav>
</header>

<div class="container">
  <!-- نموذج إدخال / تعديل السادة -->
  <section class="card" id="solid-section">
    <h2>طلبات القماش السادة</h2>
    <div class="info-text">
      إدخال طلب جديد أو تعديل طلب موجود من الجدول أسفل (زر تعديل).
    </div>

    <div class="row">
      <div class="col">
        <label for="solidColorText">اللون (كتابة):</label>
        <input type="text" id="solidColorText" placeholder="مثال: روز بيج، أخضر زيتوني..." />
      </div>
      <div class="col">
        <label for="solidColorCode">كود اللون (رقم المصبغة) <span style="font-size:11px;color:#888;">(اختياري)</span>:</label>
        <input
          type="text"
          id="solidColorCode"
          class="normalize-digits"
          inputmode="numeric"
          placeholder="مثال: 1234 أو 45-BC (يمكن تركه فارغاً)"
        />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="solidForWhom">لصالح مين (عميل / محل / مخزن):</label>
        <input type="text" id="solidForWhom" placeholder="اسم العميل، الماركة أو اسم المحل" />
      </div>
      <div class="col">
        <label for="solidPattern">الرسمة:</label>
        <input type="text" id="solidPattern" placeholder="مثال: سادة بالكامل، برن أوت بسيط..." />
      </div>
      <div class="col">
        <label for="solidQuality">الخامة:</label>
        <input type="text" id="solidQuality" placeholder="مثال: DTY، قطن 100%، فسكوز..." autocomplete="off" />
        <div id="qualitySuggestions" class="suggestions hidden" style="
          position: relative;
          z-index: 5;
        "></div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="solidStatus">حالة الطلب:</label>
        <select id="solidStatus">
          <option value="">اختار الحالة...</option>
          <option value="لم يتم التشكيل">لم يتم التشكيل</option>
          <option value="تم طلب المخبريات">تم طلب المخبريات</option>
          <option value="تم التشكيل">تم التشكيل</option>
        </select>
      </div>
      <div class="col">
        <label for="solidDate">تاريخ تقديم الطلب:</label>
        <input type="date" id="solidDate" />
      </div>
      <div class="col">
        <label for="solidQtyKg">الكمية (كغ):</label>
        <input
          type="text"
          id="solidQtyKg"
          class="normalize-digits"
          inputmode="decimal"
          placeholder="مثال: 250"
        />
      </div>
    </div>

    <button class="primary" id="solidSaveBtn">حفظ الطلب (سادة)</button>
    <div class="msg" id="solidMsg"></div>
  </section>

  <!-- جدول المخبريات -->
  <section class="card">
    <h3>جدول المخبريات (حالة الطلب = تم طلب المخبريات)</h3>
    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>اللون</th>
        <th>كود اللون</th>
        <th>لصالح مين</th>
        <th>الخامة</th>
        <th>الكمية (كغ)</th>
        <th>تاريخ الطلب</th>
        <th>الحالة</th>
        <th>إجراءات</th>
      </tr>
      </thead>
      <tbody id="labTableBody"></tbody>
    </table>
    <div class="totals" id="labTotals"></div>
  </section>

  <!-- جدول التشكيلات -->
  <section class="card">
    <h3>جدول التشكيلات / الإنتاج (حالة الطلب = لم يتم التشكيل أو تم التشكيل)</h3>

    <div class="filter-bar">
      <span>فلترة حسب الاستلام:</span>
      <button class="filter-btn active" id="filterAll">الكل</button>
      <button class="filter-btn" id="filterReceived">تم استلامه</button>
      <button class="filter-btn" id="filterNotReceived">لم يستلم بعد</button>
    </div>

    <div class="filter-bar">
      <span>فلترة إضافية:</span>
      <input
        type="text"
        id="filterClient"
        class="filter-input"
        placeholder="بحث باسم العميل / المحل..."
      />
      <input
        type="text"
        id="filterQuality"
        class="filter-input"
        placeholder="بحث باسم الخامة..."
      />
      <span>من تاريخ:</span>
      <input type="date" id="filterDateFrom" />
      <span>إلى:</span>
      <input type="date" id="filterDateTo" />
      <button class="filter-btn" id="clearFiltersBtn">مسح الفلاتر</button>
    </div>

    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>اللون</th>
        <th>كود اللون</th>
        <th>لصالح مين</th>
        <th>الرسمة</th>
        <th>الخامة</th>
        <th>الكمية (كغ)</th>
        <th>تاريخ الطلب</th>
        <th>حالة الطلب</th>
        <th>تاريخ الاستلام</th>
        <th>إجراءات</th>
      </tr>
      </thead>
      <tbody id="solidMainTableBody"></tbody>
    </table>
    <div class="totals" id="solidTotals"></div>
  </section>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<script>
  /************ تهيئة Firebase ************/
  const firebaseConfig = {
    apiKey: "AIzaSyAiidqHba1MY8D_AnbOv3DWSOjaeGXwB7A",
    authDomain: "adlatex-fabric-tracking.firebaseapp.com",
    projectId: "adlatex-fabric-tracking",
    storageBucket: "adlatex-fabric-tracking.firebasestorage.app",
    messagingSenderId: "448342410940",
    appId: "1:448342410940:web:06d676113caad3d82d72b9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /************ دالة ترجع تاريخ اليوم بصيغة input date ************/
  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  /************ تحويل الأرقام العربية-الهندية إلى أرقام عادية ************/
  function normalizeArabicDigits(str) {
    if (!str) return str;
    const map = {
      "٠": "0","١": "1","٢": "2","٣": "3","٤": "4",
      "٥": "5","٦": "6","٧": "7","٨": "8","٩": "9"
    };
    return String(str).replace(/[٠-٩]/g, ch => map[ch] ?? ch);
  }

  function setupDigitNormalization() {
    const inputs = document.querySelectorAll(".normalize-digits");
    inputs.forEach(input => {
      if (input.dataset.digitNormalized === "1") return;
      input.dataset.digitNormalized = "1";
      input.addEventListener("input", () => {
        const current = input.value;
        const normalized = normalizeArabicDigits(current);
        if (normalized !== current) {
          const pos = input.selectionStart;
          input.value = normalized;
          try { input.setSelectionRange(pos, pos); } catch (e) {}
        }
      });
    });
  }

  /************ ربط العناصر ************/
  const solidColorText = document.getElementById("solidColorText");
  const solidColorCode = document.getElementById("solidColorCode");
  const solidForWhom   = document.getElementById("solidForWhom");
  const solidPattern   = document.getElementById("solidPattern");
  const solidQuality   = document.getElementById("solidQuality");
  const solidStatus    = document.getElementById("solidStatus");
  const solidDate      = document.getElementById("solidDate");
  const solidQtyKg     = document.getElementById("solidQtyKg");
  const solidSaveBtn   = document.getElementById("solidSaveBtn");
  const solidMsg       = document.getElementById("solidMsg");

  const labTableBody   = document.getElementById("labTableBody");
  const labTotals      = document.getElementById("labTotals");

  const solidMainTableBody = document.getElementById("solidMainTableBody");
  const solidTotals        = document.getElementById("solidTotals");

  const filterAll        = document.getElementById("filterAll");
  const filterReceived   = document.getElementById("filterReceived");
  const filterNotReceived= document.getElementById("filterNotReceived");

  const filterClient     = document.getElementById("filterClient");
  const filterQualityInp = document.getElementById("filterQuality");
  const filterDateFrom   = document.getElementById("filterDateFrom");
  const filterDateTo     = document.getElementById("filterDateTo");
  const clearFiltersBtn  = document.getElementById("clearFiltersBtn");

  let solidOrders = [];       // كل الطلبات من Firestore
  let solidEditId = null;     // ID الطلب الذي نعدّله حالياً

  let solidFilter = "all";    // all | received | not_received
  let filterClientText = "";
  let filterQualityText = "";
  let filterDateFromVal = "";
  let filterDateToVal   = "";

  // تعبئة التاريخ افتراضياً
  solidDate.value = todayISO();

  function clearSolidForm() {
    solidColorText.value = "";
    solidColorCode.value = "";
    solidForWhom.value   = "";
    solidPattern.value   = "";
    solidQuality.value   = "";
    solidStatus.value    = "";
    solidDate.value      = todayISO();
    solidQtyKg.value     = "";
    solidEditId          = null;
    solidSaveBtn.textContent = "حفظ الطلب (سادة)";
  }

  /************ حفظ / تعديل طلب سادة ************/
  async function saveSolidOrder() {
    // احتفاظ بتاريخ الاستلام ووقت الإنشاء في حالة التعديل
    let existingReceivedAt = null;
    let existingCreatedAt  = null;
    if (solidEditId !== null) {
      const existingObj = solidOrders.find(o => o.id === solidEditId);
      if (existingObj && existingObj.data) {
        if (existingObj.data.receivedAt) {
          existingReceivedAt = existingObj.data.receivedAt;
        }
        if (existingObj.data.createdAt) {
          existingCreatedAt = existingObj.data.createdAt;
        }
      }
    }

    // تحويل الأرقام الهندية إلى عربية قبل القراءة
    solidColorCode.value = normalizeArabicDigits(solidColorCode.value);
    solidQtyKg.value     = normalizeArabicDigits(solidQtyKg.value);

    const qtyStr = solidQtyKg.value.trim();
    const qtyKg  = qtyStr ? Number(qtyStr) : null;

    const data = {
      colorText: solidColorText.value.trim(),
      colorCode: solidColorCode.value.trim(),
      forWhom  : solidForWhom.value.trim(),
      pattern  : solidPattern.value.trim(),
      quality  : solidQuality.value.trim(),
      status   : solidStatus.value,
      date     : solidDate.value,
      qtyKg    : qtyKg,
      receivedAt: existingReceivedAt || null
    };

    if (!data.colorText ||
        !data.forWhom ||
        !data.status ||
        !data.date ||
        data.qtyKg === null) {

      solidMsg.textContent = "من فضلك املئي جميع الحقول الأساسية (اللون، لصالح مين، حالة الطلب، التاريخ، الكمية).";
      solidMsg.style.color = "red";
      return;
    }

    try {
      if (solidEditId === null) {
        const newData = {
          ...data,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection("solid_orders").add(newData);
        solidMsg.textContent = "تم حفظ طلب السادة بنجاح ✅";
      } else {
        const updateData = { ...data };
        if (existingCreatedAt) {
          updateData.createdAt = existingCreatedAt;
        }
        await db.collection("solid_orders").doc(solidEditId).update(updateData);
        solidMsg.textContent = "تم تحديث طلب السادة بنجاح ✅";
      }
      solidMsg.style.color = "green";
      clearSolidForm();
      setTimeout(() => { solidMsg.textContent = ""; }, 2000);
    } catch (err) {
      console.error(err);
      solidMsg.textContent = "حدث خطأ أثناء الحفظ، تأكدي من اتصال الإنترنت أو من صلاحيات Firestore.";
      solidMsg.style.color = "red";
    }
  }

  solidSaveBtn.addEventListener("click", saveSolidOrder);

  /************ الفلترة حسب الاستلام ************/
  function setSolidFilter(filter) {
    solidFilter = filter;
    [filterAll, filterReceived, filterNotReceived].forEach(btn => btn.classList.remove("active"));
    if (filter === "all")         filterAll.classList.add("active");
    if (filter === "received")    filterReceived.classList.add("active");
    if (filter === "not_received")filterNotReceived.classList.add("active");
    renderTables();
  }

  filterAll.addEventListener("click", () => setSolidFilter("all"));
  filterReceived.addEventListener("click", () => setSolidFilter("received"));
  filterNotReceived.addEventListener("click", () => setSolidFilter("not_received"));

  filterClient.addEventListener("input", () => {
    filterClientText = filterClient.value.trim().toLowerCase();
    renderTables();
  });

  filterQualityInp.addEventListener("input", () => {
    filterQualityText = filterQualityInp.value.trim().toLowerCase();
    renderTables();
  });

  filterDateFrom.addEventListener("change", () => {
    filterDateFromVal = filterDateFrom.value;
    renderTables();
  });

  filterDateTo.addEventListener("change", () => {
    filterDateToVal = filterDateTo.value;
    renderTables();
  });

  clearFiltersBtn.addEventListener("click", () => {
    filterClient.value     = "";
    filterQualityInp.value = "";
    filterDateFrom.value   = "";
    filterDateTo.value     = "";
    filterClientText = "";
    filterQualityText = "";
    filterDateFromVal = "";
    filterDateToVal   = "";
    setSolidFilter("all");
  });

  /************ بناء الاقتراحات لخانة الخامة ************/
  function updateQualitySuggestionsList() {
    const suggestionsBox = document.getElementById("qualitySuggestions");
    if (!suggestionsBox) return;
    const set = new Set();
    solidOrders.forEach(o => {
      if (o.data && o.data.quality) set.add(o.data.quality);
    });
    const html = Array.from(set).map(q => `<div class="quality-option" data-val="${q}">${q}</div>`).join("");
    suggestionsBox.innerHTML = html;
  }

  const qualitySuggestions = document.getElementById("qualitySuggestions");

  solidQuality.addEventListener("input", () => {
    const val = solidQuality.value.trim().toLowerCase();
    const options = qualitySuggestions.querySelectorAll(".quality-option");
    let anyVisible = false;
    options.forEach(opt => {
      const txt = opt.dataset.val.toLowerCase();
      const show = !val || txt.includes(val);
      opt.style.display = show ? "block" : "none";
      if (show) anyVisible = true;
    });
    if (anyVisible) qualitySuggestions.classList.remove("hidden");
    else qualitySuggestions.classList.add("hidden");
  });

  qualitySuggestions.addEventListener("click", (e) => {
    const opt = e.target.closest(".quality-option");
    if (!opt) return;
    solidQuality.value = opt.dataset.val;
    qualitySuggestions.classList.add("hidden");
  });

  document.addEventListener("click", (e) => {
    if (!qualitySuggestions.contains(e.target) && e.target !== solidQuality) {
      qualitySuggestions.classList.add("hidden");
    }
  });

  /************ عرض الجداول ************/
  function renderTables() {
    // تقسيم الطلبات
    const labOrders = solidOrders.filter(o => o.data && o.data.status === "تم طلب المخبريات");
    const mainOrders = solidOrders.filter(o => o.data && (o.data.status === "تم التشكيل" || o.data.status === "لم يتم التشكيل"));

    // جدول المخبريات
    labTableBody.innerHTML = "";
    let labCount = 0;
    let labTotal = 0;
    labOrders.forEach((o, i) => {
      const d = o.data;
      labCount++;
      if (d.qtyKg) labTotal += Number(d.qtyKg);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td class="wrap-cell">${d.colorText || "—"}</td>
        <td>${d.colorCode || "—"}</td>
        <td class="wrap-cell">${d.forWhom || "—"}</td>
        <td class="wrap-cell">${d.quality || "—"}</td>
        <td>${d.qtyKg ?? "—"}</td>
        <td>${d.date || "—"}</td>
        <td><span class="status-pill status-lab">تم طلب المخبريات</span></td>
        <td class="actions-cell">
          <button class="small-btn lab-move" data-id="${o.id}" data-action="lab-to-printed">تشكيل</button>
          <button class="small-btn edit" data-id="${o.id}" data-action="edit">تعديل</button>
          <button class="small-btn delete" data-id="${o.id}" data-action="delete">حذف</button>
        </td>
      `;
      labTableBody.appendChild(tr);
    });
    labTotals.textContent = `عدد المخبريات: ${labCount} | إجمالي الكمية: ${labTotal || 0} كغ`;

    // جدول التشكيلات + الفلاتر
    let rows = mainOrders.slice();

    if (solidFilter === "received") {
      rows = rows.filter(o => o.data && o.data.receivedAt);
    } else if (solidFilter === "not_received") {
      rows = rows.filter(o => o.data && !o.data.receivedAt);
    }

    if (filterClientText) {
      rows = rows.filter(o => (o.data.forWhom || "").toLowerCase().includes(filterClientText));
    }
    if (filterQualityText) {
      rows = rows.filter(o => (o.data.quality || "").toLowerCase().includes(filterQualityText));
    }

    if (filterDateFromVal) {
      rows = rows.filter(o => (o.data.date || "") >= filterDateFromVal);
    }
    if (filterDateToVal) {
      rows = rows.filter(o => (o.data.date || "") <= filterDateToVal);
    }

    solidMainTableBody.innerHTML = "";
    let totalCount = 0;
    let totalQty   = 0;

    // ترتيب حسب التاريخ ثم اسم اللون (الأحدث أولاً)
    rows.sort((a, b) => {
      const da = a.data.date || "";
      const db = b.data.date || "";
      const cmp = db.localeCompare(da); // الأحدث أولاً
      if (cmp !== 0) return cmp;
      return (a.data.colorText || "").localeCompare(b.data.colorText || "");
    });

    rows.forEach((o, index) => {
      const d = o.data;
      totalCount++;
      if (d.qtyKg) totalQty += Number(d.qtyKg);

      let statusClass = "status-not-printed";
      if (d.status === "تم التشكيل")   statusClass = "status-printed";
      if (d.status === "تم الاستلام")  statusClass = "status-received";

      let actionsHtml = `
        <button class="small-btn edit" data-id="${o.id}" data-action="edit">تعديل</button>
        <button class="small-btn delete" data-id="${o.id}" data-action="delete">حذف</button>
      `;

      if (d.status === "لم يتم التشكيل") {
        actionsHtml =
          `<button class="small-btn mark-printed" data-id="${o.id}" data-action="mark-printed">تم التشكيل</button>` +
          actionsHtml;
      } else if (d.status === "تم التشكيل") {
        if (d.receivedAt) {
          actionsHtml =
            `<button class="small-btn unreceive" data-id="${o.id}" data-action="unreceive">إلغاء الاستلام</button>` +
            actionsHtml;
        } else {
          actionsHtml =
            `<button class="small-btn mark-received" data-id="${o.id}" data-action="mark-received">تم الاستلام</button>` +
            actionsHtml;
        }
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td class="wrap-cell">${d.colorText || "—"}</td>
        <td>${d.colorCode || "—"}</td>
        <td class="wrap-cell">${d.forWhom || "—"}</td>
        <td class="pattern-cell">${d.pattern || "—"}</td>
        <td class="wrap-cell">${d.quality || "—"}</td>
        <td>${d.qtyKg ?? "—"}</td>
        <td>${d.date || "—"}</td>
        <td><span class="status-pill ${statusClass}">${d.status || "—"}</span></td>
        <td>${d.receivedAt || "—"}</td>
        <td class="actions-cell">${actionsHtml}</td>
      `;
      solidMainTableBody.appendChild(tr);
    });

    solidTotals.textContent = `عدد الطلبات: ${totalCount} | إجمالي الكمية: ${totalQty || 0} كغ`;

    // تحديث قائمة الخامات للاقتراحات
    updateQualitySuggestionsList();
  }

  /************ أزرار الجدول (حذف / تعديل / تغيير الحالة) ************/
  async function deleteOrder(id) {
    const ok = confirm("هل تريدين حذف هذا الطلب نهائياً؟");
    if (!ok) return;
    try {
      await db.collection("solid_orders").doc(id).delete();
    } catch (err) {
      console.error(err);
      alert("لم يتم الحذف، تأكدي من اتصال الإنترنت أو من صلاحيات Firestore.");
    }
  }

  async function markPrinted(id) {
    const today = todayISO();
    try {
      await db.collection("solid_orders").doc(id).update({
        status: "تم التشكيل",
        date: today
      });
    } catch (err) {
      console.error(err);
      alert("لم يتم تغيير الحالة إلى تم التشكيل، تأكدي من اتصال الإنترنت أو من صلاحيات Firestore.");
    }
  }

  async function markReceived(id) {
    const now = new Date().toLocaleString("ar-EG");
    try {
      await db.collection("solid_orders").doc(id).update({
        status: "تم التشكيل",
        receivedAt: now
      });
    } catch (err) {
      console.error(err);
      alert("لم يتم وضع تم الاستلام، تأكدي من اتصال الإنترنت أو من صلاحيات Firestore.");
    }
  }

  async function unreceiveOrder(id) {
    const ok = confirm("هل تريدين إلغاء الاستلام لهذا الطلب؟");
    if (!ok) return;
    try {
      await db.collection("solid_orders").doc(id).update({
        receivedAt: null
      });
    } catch (err) {
      console.error(err);
      alert("لم يتم إلغاء الاستلام، تأكدي من اتصال الإنترنت أو من صلاحيات Firestore.");
    }
  }

  async function moveLabToPrinted(id) {
    const ok = confirm("سيتم نقل هذا الطلب من جدول المخبريات إلى جدول التشكيلات (تم التشكيل). هل أنت متأكدة؟");
    if (!ok) return;
    const today = todayISO();
    try {
      await db.collection("solid_orders").doc(id).update({
        status: "تم التشكيل",
        date: today
      });
    } catch (err) {
      console.error(err);
      alert("لم يتم نقل الطلب للتشكيلات، تأكدي من اتصال الإنترنت أو من صلاحيات Firestore.");
    }
  }

  labTableBody.addEventListener("click", (e) => {
    const btn = e.target.closest(".small-btn");
    if (!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    if (!id || !action) return;

    if (action === "delete") {
      deleteOrder(id);
    }
    if (action === "lab-to-printed") {
      moveLabToPrinted(id);
    }
    if (action === "edit") {
      const orderObj = solidOrders.find(o => o.id === id);
      if (!orderObj) return;
      const order = orderObj.data;

      // تعبئة النموذج مباشرة للتعديل (بدون وضع تعديل)
      solidColorText.value = order.colorText || "";
      solidColorCode.value = order.colorCode || "";
      solidForWhom.value   = order.forWhom || "";
      solidPattern.value   = order.pattern || "";
      solidQuality.value   = order.quality || "";
      solidStatus.value    = order.status || "";
      solidDate.value      = order.date || todayISO();
      solidQtyKg.value     = order.qtyKg ?? "";
      solidEditId          = id;
      solidSaveBtn.textContent = "تعديل الطلب (سادة)";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  });

  solidMainTableBody.addEventListener("click", (e) => {
    const btn = e.target.closest(".small-btn");
    if (!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    if (!id || !action) return;

    if (action === "delete") {
      deleteOrder(id);
    }
    if (action === "mark-printed") {
      markPrinted(id);
    }
    if (action === "mark-received") {
      markReceived(id);
    }
    if (action === "unreceive") {
      unreceiveOrder(id);
    }
    if (action === "edit") {
      const orderObj = solidOrders.find(o => o.id === id);
      if (!orderObj) return;
      const order = orderObj.data;

      // تعبئة النموذج مباشرة للتعديل
      solidColorText.value = order.colorText || "";
      solidColorCode.value = order.colorCode || "";
      solidForWhom.value   = order.forWhom || "";
      solidPattern.value   = order.pattern || "";
      solidQuality.value   = order.quality || "";
      solidStatus.value    = order.status || "";
      solidDate.value      = order.date || todayISO();
      solidQtyKg.value     = order.qtyKg ?? "";
      solidEditId          = id;
      solidSaveBtn.textContent = "تعديل الطلب (سادة)";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  });

  /************ الاستماع للتغييرات من Firestore ************/
  db.collection("solid_orders")
    .orderBy("createdAt", "asc")
    .onSnapshot((snapshot) => {
      solidOrders = snapshot.docs.map(doc => ({
        id: doc.id,
        data: doc.data()
      }));
      renderTables();
    }, (error) => {
      console.error("Firestore listen error:", error);
      solidMsg.textContent = "مشكلة في الاتصال بقاعدة البيانات (الصلاحيات أو الإنترنت).";
      solidMsg.style.color = "red";
    });

  // تفعيل تحويل الأرقام الهندية → عربية
  setupDigitNormalization();
</script>
</body>
</html>
